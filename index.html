<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catálogo Barretodo</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
  h1 { color: #007bff; text-align: center; }
  #buscador { width: 100%; max-width: 400px; margin: 0 auto 20px; padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
  table { width: 100%; border-collapse: collapse; background: white; }
  th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
  th { background: #007bff; color: white; }
  input.cantidad { width: 60px; padding: 6px; }
  tfoot td { font-weight: bold; }
  #totales-row td { background: #eee; }
  button#abrir-modal { margin: 20px 0; padding: 12px 24px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; display: block; margin-left: auto; margin-right: auto;}
  button#abrir-modal:hover { background-color: #218838; }
</style>
</head>
<body>

<h1>Catálogo Barretodo</h1>
<input type="text" id="buscador" placeholder="Buscar producto..." />

<table id="tabla-productos">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Precio Unitario</th>
      <th>Cantidad</th>
      <th>Subtotal</th>
    </tr>
  </thead>
  <tbody>
    <!-- Productos cargados desde JSON -->
  </tbody>
  <tfoot>
    <tr id="totales-row">
      <td colspan="3" style="text-align:right;">Total sin descuento:</td>
      <td id="total-sin-descuento">$0</td>
    </tr>
    <tr id="descuento-row" style="display:none;">
      <td colspan="3" style="text-align:right;">Descuento aplicado:</td>
      <td id="descuento">$0</td>
    </tr>
    <tr id="total-final-row" style="display:none; font-weight:bold;">
      <td colspan="3" style="text-align:right;">Total final:</td>
      <td id="total-final">$0</td>
    </tr>
  </tfoot>
</table>

<button id="abrir-modal">Generar Presupuesto</button>

<!-- Modal datos cliente -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:1000;">
  <div style="background:white; max-width:400px; margin:100px auto; padding:20px; border-radius:10px; position:relative;">
    <span onclick="document.getElementById('modal').style.display='none'" style="position:absolute; right:10px; top:10px; cursor:pointer; font-weight:bold;">×</span>
    <h3>Completar datos para presupuesto</h3>
    <form id="form-datos" style="display: flex; flex-direction: column; gap: 10px;">
      <label for="nombre" style="font-weight: bold;">Nombre completo *</label>
      <input id="nombre" name="nombre" required type="text" style="padding:8px; border:1px solid #ccc; border-radius:4px;" />
      <label for="telefono" style="font-weight: bold;">Teléfono *</label>
      <input id="telefono" name="telefono" required type="tel" style="padding:8px; border:1px solid #ccc; border-radius:4px;" />
      <label for="email" style="font-weight: bold;">Email *</label>
      <input id="email" name="email" required type="email" style="padding:8px; border:1px solid #ccc; border-radius:4px;" />
      <label for="direccion" style="font-weight: bold;">Dirección *</label>
      <input id="direccion" name="direccion" required type="text" style="padding:8px; border:1px solid #ccc; border-radius:4px;" />
      <label for="nota" style="font-weight: bold;">Agregar nota</label>
      <textarea id="nota" name="nota" placeholder="Escribí una nota adicional (opcional)" rows="3" style="padding:8px; border:1px solid #ccc; border-radius:4px; resize: vertical;"></textarea>
      <button type="submit" style="background-color:#28a745; color:white; padding:10px; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">
        Generar PDF
      </button>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("tu_userid_aqui"); // reemplazá con tu userid

  let productos = [];

  async function cargarProductos() {
    try {
      const resp = await fetch('productos.json');
      const data = await resp.json();
      productos = data.categorias.flatMap(c =>
        c.productos.map(p => ({ nombre: p.nombre, precio: Number(p.precio) }))
      );
      mostrarProductos(productos);
    } catch (e) {
      alert("Error cargando productos.json: " + e);
    }
  }

  function mostrarProductos(lista) {
    const tbody = document.querySelector("#tabla-productos tbody");
    tbody.innerHTML = "";
    lista.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.nombre}</td>
        <td class="precio">$${p.precio.toLocaleString()}</td>
        <td><input type="number" min="0" value="0" class="cantidad" /></td>
        <td class="subtotal">$0</td>
      `;
      tbody.appendChild(tr);
    });
    agregarListenersCantidad();
    actualizarTotales();
  }

  function agregarListenersCantidad() {
    const inputs = document.querySelectorAll("input.cantidad");
    inputs.forEach(input => {
      input.addEventListener("input", () => {
        const tr = input.closest("tr");
        const precio = Number(tr.querySelector(".precio").textContent.replace(/[\$\.\,]/g, ""));
        const cantidad = Number(input.value);
        const subtotal = precio * cantidad;
        tr.querySelector(".subtotal").textContent = `$${subtotal.toLocaleString()}`;
        actualizarTotales();
      });
    });
  }

  function actualizarTotales() {
    const filas = Array.from(document.querySelectorAll("#tabla-productos tbody tr"));
    let total = 0;
    filas.forEach(tr => {
      const subtotalText = tr.querySelector(".subtotal").textContent.replace(/[\$\.\,]/g, "");
      const subtotal = Number(subtotalText) || 0;
      total += subtotal;
    });

    const totalSinDescuentoElem = document.getElementById("total-sin-descuento");
    const descuentoRow = document.getElementById("descuento-row");
    const descuentoElem = document.getElementById("descuento");
    const totalFinalRow = document.getElementById("total-final-row");
    const totalFinalElem = document.getElementById("total-final");

    totalSinDescuentoElem.textContent = `$${total.toLocaleString()}`;

    let descuento = 0;
    if (total >= 300000) {
      descuento = 0.10;
    } else if (total >= 200000) {
      descuento = 0.05;
    }

    if (descuento > 0) {
      descuentoRow.style.display = "";
      totalFinalRow.style.display = "";
      const descuentoValor = total * descuento;
      descuentoElem.textContent = `-$${descuentoValor.toLocaleString()}`;
      totalFinalElem.textContent = `$${(total - descuentoValor).toLocaleString()}`;
    } else {
      descuentoRow.style.display = "none";
      totalFinalRow.style.display = "none";
    }
  }

  document.getElementById("buscador").addEventListener("input", e => {
    const texto = e.target.value.toLowerCase();
    const filtrados = productos.filter(p => p.nombre.toLowerCase().includes(texto));
    mostrarProductos(filtrados);
  });

  document.getElementById("abrir-modal").addEventListener("click", () => {
    const filas = Array.from(document.querySelectorAll("#tabla-productos tbody tr"));
    const seleccionados = filas.filter(tr => Number(tr.querySelector("input.cantidad").value) > 0);
    if (seleccionados.length === 0) {
      alert("Seleccioná al menos un producto.");
      return;
    }
    document.getElementById("modal").style.display = "block";
  });

  document.getElementById("form-datos").addEventListener("submit", e => {
    e.preventDefault();
    const nombre = document.getElementById("nombre").value.trim();
    const telefono = document.getElementById("telefono").value.trim();
    const email = document.getElementById("email").value.trim();
    const direccion = document.getElementById("direccion").value.trim();
    const nota = document.getElementById("nota").value.trim();

    const filas = Array.from(document.querySelectorAll("#tabla-productos tbody tr"));
    const productosSeleccionados = filas.map(tr => {
      const nombreP = tr.cells[0].textContent;
      const precio = Number(tr.querySelector(".precio").textContent.replace(/[\$\.\,]/g, ""));
      const cantidad = Number(tr.querySelector("input.cantidad").value);
      if (cantidad > 0) {
        return { nombre: nombreP, precio, cantidad, subtotal: precio * cantidad };
      }
    }).filter(Boolean);

    const totalSinDescuento = productosSeleccionados.reduce((acc, p) => acc + p.subtotal, 0);
    const descuento = totalSinDescuento >= 300000 ? 0.10 : totalSinDescuento >= 200000 ? 0.05 : 0;
    const totalFinal = totalSinDescuento - (totalSinDescuento * descuento);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    doc.setFillColor(0, 123, 255);
    doc.rect(0, 0, pageWidth, 20, "F");
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text("PRESUPUESTO BARRETODO", pageWidth / 2, 13, { align: "center" });
    y += 20;
    doc.setTextColor(0, 0, 0);
    y += 10;

    doc.setFontSize(11);
    doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, y += 10);
    doc.text(`Nombre: ${nombre}`, 14, y += 8);
    doc.text(`Teléfono: ${telefono}`, 14, y += 8);
    doc.text(`Email: ${email}`, 14, y += 8);
    doc.text(`Dirección: ${direccion}`, 14, y += 8);
    if (nota) {
      const notaLines = doc.splitTextToSize(`Nota: ${nota}`, pageWidth - 28);
      doc.text(notaLines, 14, y += 8);
      y += notaLines.length * 5;
    }

    y += 10;
    doc.setFontSize(12);
    doc.text("Producto", 14, y);
    doc.text("Cant.", 120, y, { align: "right" });
    doc.text("Precio Unit.", 150, y, { align: "right" });
    doc.text("Subtotal", pageWidth - 14, y, { align: "right" });

    y += 5;
    doc.setLineWidth(0.5);
    doc.line(14, y, pageWidth - 14, y);
    y += 5;

    doc.setFontSize(11);
    productosSeleccionados.forEach(p => {
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
      doc.text(p.nombre, 14, y);
      doc.text(p.cantidad.toString(), 120, y, { align: "right" });
      doc.text(`$${p.precio.toLocaleString()}`, 150, y, { align: "right" });
      doc.text(`$${p.subtotal.toLocaleString()}`, pageWidth - 14, y, { align: "right" });
      y += 8;
    });

    y += 10;
    doc.setLineWidth(0.5);
    doc.line(14, y, pageWidth - 14, y);
    y += 10;
    doc.setFontSize(12);
    doc.text("TOTAL SIN DESCUENTO:", 14, y);
    doc.text(`$${totalSinDescuento.toLocaleString()}`, pageWidth - 14, y, { align: "right" });

    if (descuento > 0) {
      y += 8;
      doc.text(`DESCUENTO APLICADO (${descuento * 100}%):`, 14, y);
      doc.text(`-$${(totalSinDescuento * descuento).toLocaleString()}`, pageWidth - 14, y, { align: "right" });
    }

    y += 8;
    doc.setFont("helvetica", "bold");
    doc.text("TOTAL FINAL:", 14, y);
    doc.text(`$${totalFinal.toLocaleString()}`, pageWidth - 14, y, { align: "right" });

    y += 15;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text("Este presupuesto tiene validez de 48 horas.", pageWidth - 14, y += 5, { align: "right" });
    doc.text("AV. Hipolito Yrigoyen 3386, Almagro, CABA", 14, y += 6);
    doc.text("1151022954 (Escribinos por acá)", 14, y += 6);
    doc.text("Todos los medios de pago", 14, y += 6);
    doc.text("Envíos a todo CABA", 14, y += 6);
    y += 15;
    doc.setFontSize(10);
    doc.setTextColor(50);
    const mensaje = "Para gestionar la compra, por favor contactate con nosotros vía WhatsApp al 1151022954 o por correo electrónico a contacto.barretodo@gmail.com y envianos el archivo generado.";
    const lines = doc.splitTextToSize(mensaje, pageWidth - 28);
    doc.text(lines, 14, y);

    // Abrir PDF en pestaña nueva
    const blob = doc.output("blob");
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");

    document.getElementById("modal").style.display = "none";
    document.getElementById("form-datos").reset();

    // Enviar mail con EmailJS
    const filasHtml = productosSeleccionados.map(p =>
      `<tr><td>${p.nombre}</td><td>${p.cantidad}</td><td>$${p.precio.toLocaleString()}</td><td>$${p.subtotal.toLocaleString()}</td></tr>`
    ).join("");

    const mensaje_html = `
      <h2 style="color:#007bff;">PRESUPUESTO BARRETODO</h2>
      <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
      <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          ${filasHtml}
        </tbody>
      </table>
      <p><strong>Total sin descuento:</strong> $${totalSinDescuento.toLocaleString()}</p>
      <p><strong>Descuento aplicado:</strong> ${descuento * 100}% (-$${(totalSinDescuento * descuento).toLocaleString()})</p>
      <p><strong>Total final:</strong> $${totalFinal.toLocaleString()}</p>
      <h3 style="margin-top:30px;">Información de contacto del cliente</h3>
      <p><strong>Nombre:</strong> ${nombre}</p>
      <p><strong>Teléfono:</strong> ${telefono}</p>
      <p><strong>Email:</strong> ${email}</p>
      <p><strong>Dirección:</strong> ${direccion}</p>
      ${nota ? `<p><strong>Nota:</strong> ${nota}</p>` : ""}
    `;

    const templateParams = {
      nombre,
      telefono,
      email,
      direccion,
      nota,
      mensaje_html,
      reply_to: email
    };

    emailjs.send("service_pm1p5tr", "template_lyjye95", templateParams)
      .then(() => alert("Presupuesto enviado por mail correctamente."))
      .catch(error => {
        console.error("EmailJS error:", error);
        alert("Error al enviar el mail: " + (error.text || JSON.stringify(error)));
      });

    // Abrir WhatsApp con mensaje
    const msg = encodeURIComponent("Hola! Te estoy contactando por este presupuesto que acabo de generar desde el catálogo BARRETODO.");
    setTimeout(() => {
      window.open("https://wa.me/541151022954?text=" + msg, "_blank");
    }, 500);
  });

  cargarProductos();
</script>

</body>
</html>
