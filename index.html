<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catálogo Barretodo</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
  #logo { max-width: 200px; display: block; margin: 0 auto 20px; }
  h1, h2, h3 { color: #007bff; text-align: center; }
  #intro-text, #footer-text { max-width: 900px; margin: 0 auto 20px; font-size: 16px; color: #333; }
  #buscador { width: 100%; max-width: 400px; margin: 0 auto 20px; padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; display: block; }
  table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 30px; }
  th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
  th { background: #007bff; color: white; }
  input.cantidad { width: 60px; padding: 6px; }
  tfoot td { font-weight: bold; }
  #totales-container { max-width: 900px; margin: 0 auto 40px; background: #f1f1f1; padding: 15px; border-radius: 8px; font-size: 18px; }
  #totales-container span { font-weight: bold; }
  button#abrir-modal { margin: 20px auto 40px; padding: 12px 24px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; display: block;}
  button#abrir-modal:hover { background-color: #218838; }
  .categoria-titulo { background: #004085; color: white; padding: 10px; font-size: 18px; text-align: center; border-radius: 6px 6px 0 0; margin-top: 30px; }
  .no-products { font-style: italic; color: #888; padding: 10px; text-align: center; }
</style>
</head>
<body>

<!-- Logo (poné la URL o base64 de tu logo acá) -->
<img id="logo" src="https://yourdomain.com/path/to/logo.png" alt="Logo Barretodo" />

<!-- Texto de introducción arriba -->
<div id="intro-text">
  <p>Bienvenidos al catálogo oficial de BARRETODO. Aquí encontrarás una amplia variedad de productos para limpieza, higiene y descartables, organizados por categorías para facilitar tu compra. Aprovechá nuestros descuentos por volumen y pagá con todos los medios disponibles. Para consultas o pedidos personalizados, contactanos al WhatsApp 1151022954.</p>
</div>

<!-- Buscador -->
<input type="text" id="buscador" placeholder="Buscar producto en todo el catálogo..." />

<!-- Contenedor productos por categorías -->
<div id="productos-container" style="max-width:900px; margin: 0 auto;"></div>

<!-- Totales con descuento -->
<div id="totales-container" style="display:none;">
  <p>Total sin descuento: <span id="total-sin-descuento">$0</span></p>
  <p id="descuento-line" style="display:none;">Descuento aplicado: <span id="descuento-porcentaje">0%</span> (-<span id="descuento-valor">$0</span>)</p>
  <p style="font-size:20px; font-weight:bold;">Total final: <span id="total-final">$0</span></p>
</div>

<!-- Botón generar presupuesto -->
<button id="abrir-modal">Generar Presupuesto</button>

<!-- Texto fijo abajo -->
<div id="footer-text" style="max-width:900px; margin: 0 auto; font-size: 14px; color:#666; border-top: 1px solid #ccc; padding-top: 20px; text-align:center;">
  <p>AV. Hipólito Yrigoyen 3386, Almagro, CABA | Tel: 1151022954 (WhatsApp) | Todos los medios de pago | Envíos a todo CABA</p>
  <p>¡Gracias por confiar en BARRETODO! Para consultas o pedidos, contactanos vía WhatsApp o mail.</p>
</div>

<!-- Modal datos cliente -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:1000;">
  <div style="background:white; max-width:400px; margin:100px auto; padding:20px; border-radius:10px; position:relative;">
    <span onclick="document.getElementById('modal').style.display='none'" style="position:absolute; right:10px; top:10px; cursor:pointer; font-weight:bold;">×</span>
    <h3>Completar datos para presupuesto</h3>
    <form id="form-datos" style="display: flex; flex-direction: column; gap: 10px;">
      <label for="nombre" style="font-weight: bold;">Nombre completo *</label>
      <input id="nombre" name="nombre" required type="text" style="padding:8px; border:1px solid #ccc; border-radius:4px;" />
      <label for="telefono" style="font-weight: bold;">Teléfono *</label>
      <input id="telefono" name="telefono" required type="tel" style="padding:8px; border:1px solid #ccc; border-radius:4px;" />
      <label for="email" style="font-weight: bold;">Email *</label>
      <input id="email" name="email" required type="email" style="padding:8px; border:1px solid #ccc; border-radius:4px;" />
      <label for="direccion" style="font-weight: bold;">Dirección *</label>
      <input id="direccion" name="direccion" required type="text" style="padding:8px; border:1px solid #ccc; border-radius:4px;" />
      <label for="nota" style="font-weight: bold;">Agregar nota</label>
      <textarea id="nota" name="nota" placeholder="Escribí una nota adicional (opcional)" rows="3" style="padding:8px; border:1px solid #ccc; border-radius:4px; resize: vertical;"></textarea>
      <button type="submit" style="background-color:#28a745; color:white; padding:10px; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">
        Generar PDF
      </button>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("tu_userid_aqui"); // poné tu user id EmailJS acá

  let productosData = []; // Array con todos productos, para buscar
  let categoriasData = []; // Para agrupar productos

  async function cargarProductos() {
    try {
      const resp = await fetch('productos.json');
      const data = await resp.json();
      categoriasData = data.categorias;
      productosData = [];
      categoriasData.forEach(cat => {
        cat.productos.forEach(prod => {
          productosData.push({
            categoria: cat.nombre,
            nombre: prod.nombre,
            precio: Number(prod.precio),
          });
        });
      });
      mostrarCategoriasYCarga(categoriasData);
      actualizarTotales();
    } catch (e) {
      alert("Error cargando productos.json: " + e);
    }
  }

  function mostrarCategoriasYCarga(categorias) {
    const contenedor = document.getElementById('productos-container');
    contenedor.innerHTML = '';

    categorias.forEach(cat => {
      // Título categoría
      const tituloCat = document.createElement('h2');
      tituloCat.classList.add('categoria-titulo');
      tituloCat.textContent = cat.nombre;
      contenedor.appendChild(tituloCat);

      // Tabla productos categoría
      const tabla = document.createElement('table');
      tabla.classList.add('tabla-categoria');
      tabla.innerHTML = `
        <thead>
          <tr>
            <th>Producto</th>
            <th>Precio Unitario</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      contenedor.appendChild(tabla);

      const tbody = tabla.querySelector('tbody');

      if (cat.productos.length === 0) {
        const noProd = document.createElement('tr');
        noProd.classList.add('no-products');
        noProd.innerHTML = `<td colspan="4">No hay productos en esta categoría.</td>`;
        tbody.appendChild(noProd);
      } else {
        cat.productos.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.nombre}</td>
            <td class="precio">$${Number(p.precio).toLocaleString()}</td>
            <td><input type="number" min="0" value="0" class="cantidad" /></td>
            <td class="subtotal">$0</td>
          `;
          tbody.appendChild(tr);
        });
      }
    });

    agregarListenersCantidad();
  }

  function agregarListenersCantidad() {
    const inputs = document.querySelectorAll("input.cantidad");
    inputs.forEach(input => {
      input.addEventListener("input", () => {
        const tr = input.closest("tr");
        const precio = Number(tr.querySelector(".precio").textContent.replace(/[\$\.\,]/g, ""));
        const cantidad = Number(input.value);
        const subtotal = precio * cantidad;
        tr.querySelector(".subtotal").textContent = `$${subtotal.toLocaleString()}`;
        actualizarTotales();
      });
    });
  }

  function actualizarTotales() {
    const subtotalesElems = document.querySelectorAll(".subtotal");
    let total = 0;
    subtotalesElems.forEach(td => {
      const val = Number(td.textContent.replace(/[\$\.\,]/g, ""));
      total += isNaN(val) ? 0 : val;
    });

    const totalSinDescElem = document.getElementById("total-sin-descuento");
    const descuentoLinea = document.getElementById("descuento-line");
    const descuentoPorcentaje = document.getElementById("descuento-porcentaje");
    const descuentoValorElem = document.getElementById("descuento-valor");
    const totalFinalElem = document.getElementById("total-final");
    const totalesCont = document.getElementById("totales-container");

    totalSinDescElem.textContent = `$${total.toLocaleString()}`;

    let descuento = 0;
    if (total >= 300000) descuento = 10;
    else if (total >= 200000) descuento = 5;

    if (descuento > 0) {
      descuentoLinea.style.display = "";
      descuentoPorcentaje.textContent = `${descuento}%`;
      const valorDesc = total * descuento / 100;
      descuentoValorElem.textContent = `-$${valorDesc.toLocaleString()}`;
      totalFinalElem.textContent = `$${(total - valorDesc).toLocaleString()}`;
    } else {
      descuentoLinea.style.display = "none";
      totalFinalElem.textContent = "$0";
    }

    totalesCont.style.display = total > 0 ? "" : "none";
  }

  // Buscador: filtra las categorías y productos
  document.getElementById("buscador").addEventListener("input", e => {
    const texto = e.target.value.toLowerCase();

    if (!texto) {
      mostrarCategoriasYCarga(categoriasData);
      return;
    }

    // Filtrar cada categoría
    const categoriasFiltradas = categoriasData.map(cat => {
      const productosFiltrados = cat.productos.filter(p => p.nombre.toLowerCase().includes(texto));
      return { nombre: cat.nombre, productos: productosFiltrados };
    }).filter(cat => cat.productos.length > 0);

    mostrarCategoriasYCarga(categoriasFiltradas);
  });

  // Botón Generar Presupuesto
  document.getElementById("abrir-modal").addEventListener("click", () => {
    const cantidades = document.querySelectorAll("input.cantidad");
    let algunProducto = false;
    cantidades.forEach(input => {
      if (Number(input.value) > 0) algunProducto = true;
    });
    if (!algunProducto) {
      alert("Seleccioná al menos un producto para generar presupuesto.");
      return;
    }
    document.getElementById("modal").style.display = "block";
  });

  // Formulario datos cliente y generación PDF + envío mail
  document.getElementById("form-datos").addEventListener("submit", e => {
    e.preventDefault();

    const nombre = document.getElementById("nombre").value.trim();
    const telefono = document.getElementById("telefono").value.trim();
    const email = document.getElementById("email").value.trim();
    const direccion = document.getElementById("direccion").value.trim();
    const nota = document.getElementById("nota").value.trim();

    // Recolectar productos seleccionados
    const seleccionados = [];
    const tablas = document.querySelectorAll("#productos-container table");
    tablas.forEach(tabla => {
      const filas = tabla.querySelectorAll("tbody tr");
      filas.forEach(tr => {
        const cantidad = Number(tr.querySelector("input.cantidad").value);
        if (cantidad > 0) {
          const nombreP = tr.cells[0].textContent;
          const precio = Number(tr.querySelector(".precio").textContent.replace(/[\$\.\,]/g, ""));
          const subtotal = precio * cantidad;
          seleccionados.push({ nombre: nombreP, cantidad, precio, subtotal });
        }
      });
    });

    if (seleccionados.length === 0) {
      alert("Seleccioná al menos un producto.");
      return;
    }

    // Calcular totales y descuentos
    const totalSinDescuento = seleccionados.reduce((acc, p) => acc + p.subtotal, 0);
    let descuentoPct = 0;
    if (totalSinDescuento >= 300000) descuentoPct = 10;
    else if (totalSinDescuento >= 200000) descuentoPct = 5;
    const valorDescuento = totalSinDescuento * descuentoPct / 100;
    const totalFinal = totalSinDescuento - valorDescuento;

    // Generar PDF con jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    // Logo (opcional)
    // doc.addImage("URL_o_base64_de_logo", "PNG", 14, 10, 50, 15);

    // Título
    doc.setFillColor(0, 123, 255);
    doc.rect(0, 0, pageWidth, 20, "F");
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text("PRESUPUESTO BARRETODO", pageWidth / 2, 13, { align: "center" });
    y += 20;
    doc.setTextColor(0, 0, 0);
    y += 10;

    // Datos cliente y fecha
    doc.setFontSize(11);
    doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, y += 10);
    doc.text(`Nombre: ${nombre}`, 14, y += 8);
    doc.text(`Teléfono: ${telefono}`, 14, y += 8);
    doc.text(`Email: ${email}`, 14, y += 8);
    doc.text(`Dirección: ${direccion}`, 14, y += 8);
    if (nota) {
      const lines = doc.splitTextToSize(`Nota: ${nota}`, pageWidth - 28);
      doc.text(lines, 14, y += 8);
      y += lines.length * 5;
    }

    y += 10;

    // Encabezados tabla
    doc.setFontSize(12);
    doc.text("Producto", 14, y);
    doc.text("Cant.", 120, y, { align: "right" });
    doc.text("Precio Unit.", 150, y, { align: "right" });
    doc.text("Subtotal", pageWidth - 14, y, { align: "right" });

    y += 5;
    doc.setLineWidth(0.5);
    doc.line(14, y, pageWidth - 14, y);
    y += 5;

    doc.setFontSize(11);

    // Productos seleccionados
    seleccionados.forEach(p => {
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
      doc.text(p.nombre, 14, y);
      doc.text(p.cantidad.toString(), 120, y, { align: "right" });
      doc.text(`$${p.precio.toLocaleString()}`, 150, y, { align: "right" });
      doc.text(`$${p.subtotal.toLocaleString()}`, pageWidth - 14, y, { align: "right" });
      y += 8;
    });

    y += 10;
    doc.setLineWidth(0.5);
    doc.line(14, y, pageWidth - 14, y);
    y += 10;
    doc.setFontSize(12);
   
