<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catálogo BARRETODO</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  header { background: #007bff; color: white; padding: 10px 20px; display: flex; align-items: center; }
  header img { height: 50px; margin-right: 15px; }
  h1 { margin: 0; font-size: 24px; }
  #buscador { margin: 20px; width: calc(100% - 40px); padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
  section.categoria { margin: 20px; }
  section.categoria h2 { background: #f0f0f0; padding: 8px 12px; border-radius: 6px; border-left: 5px solid #007bff; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  table th { background-color: #007bff; color: white; }
  input.cantidad { width: 60px; padding: 4px; font-size: 14px; }
  tfoot tr td { font-weight: bold; }
  #total-descuento { margin: 20px; font-size: 18px; font-weight: bold; }
  button#abrir-modal { margin: 20px; padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
  button#abrir-modal:hover { background: #218838; }
</style>
</head>
<body>

<header>
  <img src="logo-barretodo.jpeg" alt="Barretodo Logo" />
  <h1>Catálogo BARRETODO</h1>
</header>

<input type="text" id="buscador" placeholder="Buscar producto..." />

<div id="catalogo"></div>

<div id="total-descuento">
  Total sin descuento: $<span id="total-sin-descuento">0</span><br/>
  <span id="texto-descuento" style="color: green; font-weight: bold;"></span><br/>
  Total final: $<span id="total-final">0</span>
</div>

<button id="abrir-modal">Generar presupuesto</button>

<!-- Modal -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:1000;">
  <div style="background:white; max-width:400px; margin:100px auto; padding:20px; border-radius:10px; position:relative;">
    <span onclick="document.getElementById('modal').style.display='none'" style="position:absolute; right:10px; top:10px; cursor:pointer; font-weight:bold;">×</span>
    <h3>Completar datos para presupuesto</h3>
    <form id="form-datos" style="display: flex; flex-direction: column; gap: 10px;">
      <label for="nombre" style="font-weight: bold;">Nombre completo *</label>
      <input id="nombre" name="nombre" required type="text" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
      
      <label for="telefono" style="font-weight: bold;">Teléfono *</label>
      <input id="telefono" name="telefono" required type="tel" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
      
      <label for="email" style="font-weight: bold;">Email *</label>
      <input id="email" name="email" required type="email" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
      
      <label for="direccion" style="font-weight: bold;">Dirección *</label>
      <input id="direccion" name="direccion" required type="text" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
      
      <label for="nota" style="font-weight: bold;">Agregar nota</label>
      <textarea id="nota" name="nota" rows="3" placeholder="Escribí una nota adicional (opcional)" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
      
      <button class="btn-enviar" type="submit" style="background-color: #28a745; color: white; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
        Generar PDF
      </button>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  // Configura EmailJS con tu user ID (debe estar configurado ya)
  emailjs.init("PA7qGrJKXL9PpzVzI");

  // Variables globales
  let productosJSON = null;

  // Función para formatear número a moneda local
  function formatPrecio(num) {
    return num.toLocaleString('es-AR');
  }

  // Carga productos desde JSON
  async function cargarProductos() {
    const res = await fetch("productos.json");
    productosJSON = await res.json();
    mostrarProductos(productosJSON.categorias);
  }

  // Mostrar productos por categoría
  function mostrarProductos(categorias) {
    const contenedor = document.getElementById("catalogo");
    contenedor.innerHTML = "";

    categorias.forEach(categoria => {
      const seccion = document.createElement("section");
      seccion.classList.add("categoria");
      seccion.dataset.nombre = categoria.nombre;

      const titulo = document.createElement("h2");
      titulo.textContent = categoria.nombre;
      seccion.appendChild(titulo);

      const tabla = document.createElement("table");
      tabla.innerHTML = `
        <thead>
          <tr>
            <th>Producto</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
        ${categoria.productos.map(p => `
          <tr>
            <td>${p.nombre}</td>
            <td class="precio">$${formatPrecio(Number(p.precio))}</td>
            <td><input type="number" min="0" value="0" class="cantidad" /></td>
            <td class="subtotal">$0</td>
          </tr>
        `).join("")}
        </tbody>
      `;
      seccion.appendChild(tabla);

      contenedor.appendChild(seccion);
    });

    // Agregar listeners para recalcular subtotales y totales al cambiar cantidad
    document.querySelectorAll("input.cantidad").forEach(input => {
      input.addEventListener("input", () => {
        calcularSubtotales();
        calcularTotales();
      });
    });
  }

  // Calcular subtotales
  function calcularSubtotales() {
    document.querySelectorAll("section.categoria").forEach(seccion => {
      seccion.querySelectorAll("tbody tr").forEach(tr => {
        const precio = parseFloat(tr.querySelector(".precio").textContent.replace(/[^0-9.-]+/g,""));
        const cantidad = parseInt(tr.querySelector(".cantidad").value) || 0;
        const subtotal = precio * cantidad;
        tr.querySelector(".subtotal").textContent = `$${formatPrecio(subtotal)}`;
      });
    });
  }

  // Calcular totales y descuentos
  function calcularTotales() {
    let totalSinDesc = 0;
    document.querySelectorAll("section.categoria tbody tr").forEach(tr => {
      const subtotal = parseFloat(tr.querySelector(".subtotal").textContent.replace(/[^0-9.-]+/g,"")) || 0;
      totalSinDesc += subtotal;
    });

    const descuento = totalSinDesc >= 300000 ? 0.10 : (totalSinDesc >= 200000 ? 0.05 : 0);
    const totalFinal = totalSinDesc - (totalSinDesc * descuento);

    document.getElementById("total-sin-descuento").textContent = formatPrecio(totalSinDesc);
    document.getElementById("total-final").textContent = formatPrecio(totalFinal);

    const textoDesc = descuento > 0 ? `Descuento aplicado: ${descuento * 100}%` : "";
    document.getElementById("texto-descuento").textContent = textoDesc;
  }

  // Filtrar productos en buscador
  function filtrarProductos() {
    const texto = document.getElementById("buscador").value.toLowerCase();

    document.querySelectorAll("section.categoria").forEach(seccion => {
      let mostrarCategoria = false;
      seccion.querySelectorAll("tbody tr").forEach(tr => {
        const nombreProducto = tr.cells[0].textContent.toLowerCase();
        const coincide = nombreProducto.includes(texto);
        tr.style.display = coincide ? "" : "none";
        if (coincide) mostrarCategoria = true;
      });
      seccion.style.display = mostrarCategoria ? "" : "none";
    });
  }

  // Abrir modal solo si hay productos seleccionados (cantidad > 0)
  document.getElementById("abrir-modal").addEventListener("click", () => {
    const haySeleccion = Array.from(document.querySelectorAll("input.cantidad"))
      .some(input => parseInt(input.value) > 0);

    if (!haySeleccion) {
      alert("Seleccioná al menos un producto");
      return;
    }
    document.getElementById("modal").style.display = "block";
  });

  // Manejar envío de formulario para generar PDF + enviar mail + abrir WhatsApp
  document.getElementById("form-datos").addEventListener("submit", async (e) => {
    e.preventDefault();

    const nombre = document.getElementById("nombre").value.trim();
    const telefono = document.getElementById("telefono").value.trim();
    const email = document.getElementById("email").value.trim();
    const direccion = document.getElementById("direccion").value.trim();
    const nota = document.getElementById("nota").value.trim();

    // Recopilar productos seleccionados con cantidad > 0
    const productosSeleccionados = [];
    document.querySelectorAll("section.categoria tbody tr").forEach(tr => {
      const cantidad = parseInt(tr.querySelector(".cantidad").value);
      if (cantidad > 0) {
        const nombreP = tr.cells[0].textContent;
        const precio = parseFloat(tr.querySelector(".precio").textContent.replace(/[^0-9.-]+/g,""));
        productosSeleccionados.push({
          nombre: nombreP,
          precio,
          cantidad,
          subtotal: precio * cantidad
        });
      }
    });

    if (productosSeleccionados.length === 0) {
      alert("Seleccioná al menos un producto.");
      return;
    }

    // Totales y descuentos
    const totalSinDescuento = productosSeleccionados.reduce((acc, p) => acc + p.subtotal, 0);
    const descuento = totalSinDescuento >= 300000 ? 0.10 : (totalSinDescuento >= 200000 ? 0.05 : 0);
    const totalFinal = totalSinDescuento - (totalSinDescuento * descuento);

    // Generar PDF con jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    doc.setFillColor(0, 123, 255);
    doc.rect(0, 0, pageWidth, 20, "F");
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text("PRESUPUESTO BARRETODO", pageWidth / 2, 13, { align: "center" });
    y += 20;
    doc.setTextColor(0, 0, 0);
    y += 10;

    doc.setFontSize(11);
    doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, y += 10);
    doc.text(`Nombre: ${nombre}`, 14, y += 8);
    doc.text(`Teléfono: ${telefono}`, 14, y += 8);
    doc.text(`Email: ${email}`, 14, y += 8);
    doc.text(`Dirección: ${direccion}`, 14, y += 8);
    if (nota) {
      const notaLines = doc.splitTextToSize(`Nota: ${nota}`, pageWidth - 28);
      doc.text(notaLines, 14, y += 8);
      y += notaLines.length * 5;
    }

    y += 10;
    doc.setFontSize(12);
    doc.text("Producto", 14, y);
    doc.text("Cant.", 120, y, { align: "right" });
    doc.text("Precio Unit.", 150, y, { align: "right" });
    doc.text("Subtotal", pageWidth - 14, y, { align: "right" });

    y += 5;
    doc.setLineWidth(0.5);
    doc.line(14, y, pageWidth - 14, y);
    y += 5;

    doc.setFontSize(11);
    productosSeleccionados.forEach(p => {
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
      doc.text(p.nombre, 14, y);
      doc.text(p.cantidad.toString(), 120, y, { align: "right" });
      doc.text(`$${formatPrecio(p.precio)}`, 150, y, { align: "right" });
      doc.text(`$${formatPrecio(p.subtotal)}`, pageWidth - 14, y, { align: "right" });
      y += 8;
    });

    y += 10;
    doc.setLineWidth(0.5);
    doc.line(14, y, pageWidth - 14, y);
    y += 10;
    doc.setFontSize(12);
    doc.text("TOTAL SIN DESCUENTO:", 14, y);
    doc.text(`$${formatPrecio(totalSinDescuento)}`, pageWidth - 14, y, { align: "right" });

    if (descuento > 0) {
      y += 8;
      doc.text(`DESCUENTO APLICADO (${descuento * 100}%):`, 14, y);
      doc.text(`-$${formatPrecio(totalSinDescuento * descuento)}`, pageWidth - 14, y, { align: "right" });
    }

    y += 8;
    doc.setFont("helvetica", "bold");
    doc.text("TOTAL FINAL:", 14, y);
    doc.text(`$${formatPrecio(totalFinal)}`, pageWidth - 14, y, { align: "right" });

    y += 15;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text("Este presupuesto tiene validez de 48 horas.", pageWidth - 14, y += 5, { align: "right" });
    doc.text("AV. Hipolito Yrigoyen 3386, Almagro, CABA", 14, y += 6);
    doc.text("1151022954 (Escribinos por acá)", 14, y += 6);
    doc.text("Todos los medios de pago", 14, y += 6);
    doc.text("Envíos a todo CABA", 14, y += 6);
    y += 15;
    doc.setFontSize(10);
    doc.setTextColor(50);
    const mensaje = "Para gestionar la compra, por favor contactate con nosotros vía WhatsApp al 1151022954 o por correo electrónico a contacto.barretodo@gmail.com y envianos el archivo generado.";
    const lines = doc.splitTextToSize(mensaje, pageWidth - 28);
    doc.text(lines, 14, y);

    const blob = doc.output("blob");
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");

    document.getElementById("modal").style.display = "none";
    document.getElementById("form-datos").reset();

    // Enviar email con EmailJS
    const filasHtml = productosSeleccionados.map(p => 
      `<tr><td>${p.nombre}</td><td>${p.cantidad}</td><td>$${formatPrecio(p.precio)}</td><td>$${formatPrecio(p.subtotal)}</td></tr>`
    ).join("");

    const mensaje_html = `
      <h2 style="color:#007bff;">PRESUPUESTO BARRETODO</h2>
      <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
      <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; width:100%;">
        <thead>
          <tr>
            <th>Producto</th><th>Cantidad</th><th>Precio Unit.</th><th>Subtotal</th>
          </tr>
        </thead>
        <tbody>${filasHtml}</tbody>
      </table>
      <p><strong>Total sin descuento:</strong> $${formatPrecio(totalSinDescuento)}</p>
      <p><strong>Descuento aplicado:</strong> ${descuento * 100}%</p>
      <p><strong>Total final:</strong> $${formatPrecio(totalFinal)}</p>
      <p><strong>Nombre:</strong> ${nombre}</p>
      <p><strong>Teléfono:</strong> ${telefono}</p>
      <p><strong>Email:</strong> ${email}</p>
      <p><strong>Dirección:</strong> ${direccion}</p>
      <p><strong>Nota:</strong> ${nota || 'Ninguna'}</p>
    `;

    const templateParams = {
      nombre,
      telefono,
      email,
      direccion,
      nota,
      mensaje_html,
      reply_to: email
    };

    emailjs.send("service_pm1p5tr", "template_lyjye95", templateParams)
      .then(() => alert("Presupuesto enviado por mail correctamente."))
      .catch(error => {
        console.error("EmailJS error:", error);
        alert("Error al enviar el mail: " + (error.text || JSON.stringify(error)));
      });

    // Abrir WhatsApp luego de enviar mail
    const msgWhats = encodeURIComponent("Hola! Te estoy contactando por este presupuesto que acabo de generar desde el catálogo BARRETODO.");
    setTimeout(() => {
      window.open("https://wa.me/541151022954?text=" + msgWhats, "_blank");
    }, 500);
  });

  // Evento buscador
  document.getElementById("buscador").addEventListener("input", filtrarProductos);

  // Inicializar carga productos
  cargarProductos();
</script>

</body>
</html>
